# v0.3 Batch 1: Foundations — Implementation Summary

**Date**: 2026-02-08  
**Status**: Complete  
**Test results**: 386 passing, 0 failing, 29 test files

---

## Deliverables

### 1.1 Fix AT-7 ✅

**File**: `src/workflow/phases/brainstorm.acceptance.test.ts`

Added missing `ctx.ui.select.mockResolvedValueOnce("Start brainstorm")` mock before the approach selection mock. The brainstorm phase's skip prompt was consuming the "Approach A" mock, preventing the test from reaching the design step.

### 1.2 Streaming ✅ (already complete)

All phases (`brainstorm.ts`, `plan-write.ts`, `plan-review.ts`) already wire `makeOnStreamEvent()` into every `dispatchAgent` call. Existing tests verify this.

### 1.3 Plan review role separation ✅

**Files**: `agents/spec-reviewer.md`, `agents/architect.md`, `agents/planner.md`

- **Reviewers**: Added explicit scope (structure/completeness/dependencies/granularity), "MUST NOT modify any files", "output is a review verdict only"
- **Planner**: Added targeted revision instructions: "Apply targeted patches only. Do NOT rewrite the entire plan."

### 1.4 Reviewer write-guard ✅

**Files**: `src/dispatch.ts`, `src/workflow/phases/plan-review.ts`, `src/workflow/phases/execute.ts`

- New `hasWriteToolCalls(messages)` function in `dispatch.ts` — scans for `write`, `edit`, and bash commands with `>`, `>>`, `tee`, `sed -i`, `mv`, `cp`, `rm`, `mkdir`, `chmod`, `chown`, `touch`
- Runtime check in `plan-review.ts` `dispatchReviewers()` and `execute.ts` `runReviewLoop()` — if reviewer writes, warn + re-dispatch once; if still writes on retry, warn and continue
- 15 unit tests for `hasWriteToolCalls`, plus integration tests in both review phases

### 1.5 Targeted plan revision ✅

**Files**: `src/workflow/prompt-builder.ts`, `src/workflow/phases/plan-review.ts`

- New `buildTargetedPlanRevisionPrompt(planContent, findings, designContent)` — instructs planner to edit only referenced tasks, preserve IDs
- Replaced `buildPlanRevisionPromptFromFindings` with targeted variant in iterative review loop
- Added convergence detection: if same findings recur on consecutive cycles, escalate to user with "Approve as-is / Provide guidance / Abort"
- Extracted `rereadPlan()` helper to DRY up plan re-reading

### 1.6 Config keys ✅

**File**: `src/config.ts`

Added to `SuperteamConfig` interface and `DEFAULT_CONFIG`:

| Key | Type | Default | Purpose |
|-----|------|---------|---------|
| `testCommand` | `string` | `""` | Override auto-detection for cross-task test suite |
| `validationCadence` | `"every" \| "every-N" \| "on-demand"` | `"every"` | When to run cross-task tests |
| `validationInterval` | `number` | `3` | N for "every-N" cadence |
| `budgetCheckpointUsd` | `number` | `0` | Dollar threshold for auto-mode checkpoint (0 = use `costs.warnAtUsd`) |
| `gitIgnorePatterns` | `string[]` | `[]` | Files to exclude from orchestrator commits/diffs |

---

## Additional: Plan parser extraction (Option B)

**New file**: `src/workflow/plan-parser.ts`

- Extracted `parseTaskBlock`, `parseTaskHeadings`, `loadPlan` and internal helpers from `state.ts`
- `state.ts` re-exports with `@deprecated` markers for backward compatibility
- `plan-review.ts` and `plan-write.ts` import directly from `plan-parser.ts`
- 8 dedicated unit tests in `plan-parser.test.ts`

---

## Files changed

| File | Change |
|------|--------|
| `src/workflow/phases/brainstorm.acceptance.test.ts` | Added missing ui.select mock (AT-7 fix) |
| `agents/spec-reviewer.md` | Role separation: verdict-only scope |
| `agents/architect.md` | Role separation: verdict-only scope |
| `agents/planner.md` | Targeted revision instructions |
| `src/dispatch.ts` | Added `hasWriteToolCalls()` |
| `src/dispatch-write-guard.test.ts` | New — 15 tests for write-guard |
| `src/workflow/phases/plan-review.ts` | Write-guard, targeted revision, convergence check |
| `src/workflow/phases/plan-review.test.ts` | Tests for convergence, targeted prompt, write-guard |
| `src/workflow/phases/execute.ts` | Write-guard in review loop |
| `src/workflow/phases/execute.test.ts` | Write-guard integration test |
| `src/workflow/prompt-builder.ts` | Added `buildTargetedPlanRevisionPrompt()` |
| `src/workflow/prompt-builder.test.ts` | 5 tests for targeted revision prompt |
| `src/config.ts` | Added 5 new config keys with defaults |
| `src/config.test.ts` | 6 tests for new config keys |
| `src/workflow/plan-parser.ts` | New — extracted plan parsing logic |
| `src/workflow/plan-parser.test.ts` | New — 8 tests for plan parser |
| `src/workflow/state.ts` | Delegated parsing to plan-parser.ts with deprecated re-exports |
| `src/workflow/phases/plan-write.ts` | Import from plan-parser.ts |
| `.pi/context.md` | Updated structure docs |

## Test delta

- **Before**: 347 passing, 1 failing (AT-7), 27 test files
- **After**: 386 passing, 0 failing, 29 test files
- **New tests**: +39 across 2 new test files and 4 updated test files
