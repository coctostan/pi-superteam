# v0.3 Batch 3: Git Discipline

**Goal**: Make the git history reliable and orchestrator-controlled. Clean commits, dirty-tree safety, branch awareness.

**Duration estimate**: 1–2 days  
**Depends on**: Batch 1 (config keys for `gitIgnorePatterns`) ✅ Complete  
**Independent of**: Batch 2  
**Status**: Not started

---

## Deliverables

### 3.1 Git safety preflight

Before workflow starts (top of `runWorkflowLoop` or at brainstorm phase start), check git state.

**New module**: `src/workflow/git-preflight.ts`

**Interface**:
```typescript
export interface GitPreflightResult {
  clean: boolean;
  branch: string;
  isMainBranch: boolean;    // main, master, or configured protected branches
  uncommittedFiles: string[];
  warnings: string[];       // human-readable warnings
}

/** Check git state. Does NOT modify the repo. */
export async function runGitPreflight(cwd: string): Promise<GitPreflightResult>;
```

**Behavior**:
1. Check `git status --porcelain`. If dirty:
   - Present via `ui.select`: "Working tree has uncommitted changes. Stash / Commit first / Continue anyway / Abort"
   - "Stash" runs `git stash push -m "superteam-workflow-preflight"` automatically.
2. Check current branch. If `main` or `master`:
   - Warn via `ui.select`: "You're on main. Create branch / Continue on main / Abort"
   - "Create branch" prompts for name (default: `workflow/<slug>`), runs `git checkout -b <name>`.
3. Record `startingSha` in `OrchestratorState` for rollback baseline.

**State addition**:
```typescript
// Added to OrchestratorState
gitStartingSha?: string;
gitBranch?: string;
```

**Test**: Unit tests with mock git commands. Test dirty tree → stash path. Test main branch → branch creation path.

### 3.2 Orchestrator-controlled commits

After a task passes all reviews (and cross-task validation when Batch 2 is present), the orchestrator commits.

**Changes to `git-utils.ts`**:
```typescript
/** Stage and commit all changes with a standardized message. */
export async function commitTaskChanges(
  cwd: string,
  taskId: number,
  taskTitle: string,
  ignorePatterns?: string[],
): Promise<{ sha: string; success: boolean }>;
```

**Behavior**:
1. `git add -A` (or selective add respecting `gitIgnorePatterns` from config).
2. `git commit -m "workflow: task ${taskId} — ${taskTitle}"`.
3. Return the new commit SHA.
4. Store SHA in `TaskExecState.commitSha`.

**State addition**:
```typescript
// Added to TaskExecState
commitSha?: string;
```

**Changes to `execute.ts`**:
- After task marked complete (step h), call `commitTaskChanges()`.
- Store the returned SHA in the task state.
- If commit fails (nothing to commit, git error), warn but don't block.

**Implementer prompt change** (depends on Q2 resolution):
- If Option A: Remove "Commit after each green cycle" from `buildImplPrompt`. Add: "Do NOT commit. The orchestrator manages commits."
- If Option B: Keep current prompt. Add squash after reviews pass.

**Test**: Integration test with a real git repo (temp dir): run mock task → verify commit message format → verify SHA stored. Test with `gitIgnorePatterns` → excluded files not staged.

### 3.3 Enhanced rollback on escalation

The existing `escalate()` function offers Rollback. Enhance it with orchestrator commit awareness.

**Changes to `execute.ts` escalation**:
- Rollback now uses `task.gitShaBeforeImpl` (already tracked) to `resetToSha()`.
- After rollback, clean up: if orchestrator-controlled commits exist post-rollback SHA, they're gone (expected — `reset --hard` removes them).
- Show what's being rolled back: "Rolling back task N. Reverting N files changed since SHA abc1234."

**Test**: Integration test: implement task → commit → rollback → verify repo state matches pre-task SHA.

---

## Exit criteria

- Workflow refuses to start on dirty working tree (offers stash).
- Warning on main branch with branch creation option.
- Orchestrator commits land with `workflow: task N — <title>` format.
- Rollback reverts to pre-task state cleanly.
- `gitIgnorePatterns` excludes configured files from staging.

---

## Cross-cutting concerns

### State schema migration

New fields added to `OrchestratorState` and `TaskExecState` must be optional (`?`) for backward compatibility:

```typescript
state.gitStartingSha ??= "";
state.gitBranch ??= "";
task.commitSha ??= undefined;
```

### Testing strategy

- **Unit tests** for git preflight checks (mock git commands).
- **Integration tests** with real temp git repos for commit and rollback.
- **At least one acceptance test** for the preflight → commit → rollback flow.

### New files

| File | Purpose |
|------|---------|
| `src/workflow/git-preflight.ts` | Pre-workflow git safety checks |

### Modified files

| File | Changes |
|------|---------|
| `src/workflow/orchestrator-state.ts` | New `gitStartingSha`, `gitBranch` state fields |
| `src/workflow/orchestrator.ts` | Git preflight at workflow start |
| `src/workflow/git-utils.ts` | `commitTaskChanges()` |
| `src/workflow/phases/execute.ts` | Orchestrator commit after task completion, enhanced rollback |
| `src/workflow/prompt-builder.ts` | Implementer prompt change (no self-commits) |
