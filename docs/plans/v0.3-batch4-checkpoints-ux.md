# v0.3 Batch 4: Checkpoints & UX

**Goal**: Give the user control during execution. Cost visibility, pause points, plan adjustment, context forwarding.

**Duration estimate**: 2–3 days  
**Depends on**: Batch 2 (validation triggers checkpoints), Batch 3 (commit SHAs in progress)  
**Status**: Complete

---

## Deliverables

### 4.1 Progress summaries with cost ✅ Done (D5 from batch 3)

After each task completes, emit a deterministic summary. No LLM needed — computed from `OrchestratorState`.

**New function in `progress.ts`** (or `ui.ts`):
```typescript
export interface TaskProgressSummary {
  tasksCompleted: number;
  tasksRemaining: number;
  tasksSkipped: number;
  cumulativeCost: number;
  estimatedRemainingCost: number; // (cumulativeCost / tasksCompleted) * tasksRemaining
  changedFilesSoFar: string[];
  fixCyclesSoFar: number;
  currentTaskTitle: string;
}

export function computeProgressSummary(state: OrchestratorState): TaskProgressSummary;
export function formatProgressSummary(summary: TaskProgressSummary): string;
```

**Display**: `ui.notify(formatProgressSummary(summary), "info")` after each task completion.

**Widget update**: Update `workflow-progress` widget with live cost + completion percentage.

**Test**: Unit test for `computeProgressSummary` with various state snapshots. Test estimated cost calculation.

### 4.2 Checkpoint pause points ✅ Done

At configurable intervals, pause execution and prompt the user.

**Checkpoint triggers** (any of):
1. Every task (when `executionMode === "checkpoint"` — already exists).
2. Test failure in cross-task validation → forced checkpoint.
3. Budget threshold hit (`cumulativeCost >= costs.warnAtUsd`) → checkpoint.
4. Budget hard limit approaching (`cumulativeCost >= costs.hardLimitUsd * 0.9`) → checkpoint.

**Checkpoint UI**:
```typescript
async function presentCheckpoint(
  state: OrchestratorState,
  trigger: "scheduled" | "test-failure" | "budget-warning" | "budget-critical",
  details?: string,
  ui: any,
): Promise<"continue" | "adjust" | "abort">;
```

Displays:
```
Checkpoint: 5/20 tasks done | $15.00 spent | ~$33.00 remaining
Trigger: [scheduled / test failure in X / budget warning]
[Continue] [Adjust plan] [Abort]
```

**Integration in `execute.ts`**:
- After task completion + validation + commit, check checkpoint triggers.
- If triggered, call `presentCheckpoint()`.
- On "continue" → proceed.
- On "adjust" → enter plan revision mode (4.3).
- On "abort" → set `state.error`, return.

**Test**: Unit test: mock state at 50% completion + budget at warnAtUsd → checkpoint fires. Mock state under budget → no checkpoint. Test failure trigger → forces checkpoint regardless of cadence.

### 4.3 Minimal plan revision at checkpoints ✅ Done

When user selects "Adjust plan" at a checkpoint, present the remaining tasks for subtractive editing.

**Interface**:
```typescript
export interface PlanAdjustment {
  droppedTaskIds: number[];
  skippedTaskIds: number[];
  reorderedTaskIds?: number[];  // new ordering of remaining task IDs
}

/** Present remaining tasks for adjustment. Returns the changes. */
async function presentPlanRevision(
  state: OrchestratorState,
  ui: any,
): Promise<PlanAdjustment | null>;  // null = cancelled, go back to checkpoint

/** Apply adjustments to state. */
export function applyPlanAdjustment(
  state: OrchestratorState,
  adjustment: PlanAdjustment,
): OrchestratorState;
```

**UX flow** (using `ui.editor` or `ui.select`):
1. Show remaining tasks as a numbered list.
2. User interaction: `ui.editor` pre-filled with remaining tasks in YAML-like format. User deletes lines to drop, reorders lines, prefixes with `skip:` to skip.
3. Parse the edited list back into a `PlanAdjustment`.
4. Show confirmation: "Dropping tasks X, Y. Skipping Z. Reordering: [new order]. Confirm?"
5. Apply to state: dropped tasks removed from `state.tasks`, skipped tasks marked `status: "skipped"`, remaining tasks reindexed.

**Constraints enforced**:
- No new tasks (lines not matching existing task IDs are rejected).
- No editing task descriptions (description changes are ignored).
- Only pending/future tasks can be dropped/reordered. Completed tasks are fixed.

**Test**: Unit test for `applyPlanAdjustment`: drop 2 tasks → verify state.tasks shrinks. Reorder → verify new order. Skip → verify status. Attempt to drop completed task → rejected.

### 4.4 Post-task context forwarding ✅ Done (D6 from batch 3)

Each implementer gets a lightweight summary of what prior tasks changed.

**Changes to `prompt-builder.ts`**:
```typescript
export interface PriorTaskContext {
  title: string;
  status: string;
  changedFiles: string[];
  commitSha?: string;
}

export function buildImplPrompt(
  task: TaskExecState,
  planContext: string,
  priorTasks?: PriorTaskContext[],  // replaces single previousTaskSummary
): string;
```

**What's included**: For each completed prior task: title, status, changed files list. NOT full output. Capped at last 5 tasks to avoid prompt bloat.

**Changes to `execute.ts`**:
- Before dispatching implementer, collect `priorTasks` from completed tasks in `state.tasks`.
- Pass to `buildImplPrompt`.

**Test**: Unit test for `buildImplPrompt` with prior context → verify prompt includes file lists. Test cap at 5 tasks.

---

## Exit criteria

- Progress summary emitted after every task with accurate cost.
- Estimated remaining cost is reasonable (not wildly off).
- Checkpoint pauses execution on budget threshold.
- User can drop/skip/reorder tasks at checkpoint and workflow respects changes.
- Implementers receive prior task context (visible in prompt).

---

## Cross-cutting concerns

### State schema migration

New fields must be optional (`?`) for backward compatibility:

```typescript
task.commitSha ??= undefined;  // also needed by Batch 3
```

### Testing strategy

- **Unit tests** for computeProgressSummary, formatProgressSummary, applyPlanAdjustment, buildImplPrompt with prior context.
- **Integration tests** for checkpoint trigger logic.
- **At least one acceptance test** for the checkpoint → adjust → continue flow.

### New files

| File | Purpose |
|------|---------|
| `src/workflow/checkpoint.ts` | Checkpoint triggers, presentation, plan revision |

### Modified files

| File | Changes |
|------|---------|
| `src/workflow/phases/execute.ts` | Checkpoint integration, context forwarding |
| `src/workflow/progress.ts` | `computeProgressSummary()`, `formatProgressSummary()` |
| `src/workflow/ui.ts` | Summary formatting |
| `src/workflow/prompt-builder.ts` | `PriorTaskContext`, enhanced `buildImplPrompt` |
